---
- name: Configure Proxmox host convenience settings
  hosts: proxmox
  gather_facts: true
  tasks:
    - name: "01 Check if subscription warning is disabled"
      ansible.builtin.shell:
        cmd: >-
          grep -q "void({ //" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
      register: subscription_warning_disabled
      changed_when: false
      failed_when: false

    - name: "02 Disable subscription warning if missing"
      ansible.builtin.shell:
        cmd: >-
          sed -Ezi.bak "s/(Ext.Msg.show\(\{\s+title: gettext\('No valid sub)/void\(\{ \/\/\1/g" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js &&
          systemctl restart pveproxy.service
      when: subscription_warning_disabled.rc != 0

    - name: "03 Re-check subscription warning status"
      ansible.builtin.shell:
        cmd: >-
          grep -q "void({ //" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
      register: subscription_warning_disabled_after
      changed_when: false
      failed_when: false

    - name: "04 Assert subscription warning disabled"
      ansible.builtin.assert:
        that:
          - subscription_warning_disabled_after.rc == 0
        fail_msg: "Subscription warning patch missing."

    - name: "05 Deploy colorful bashrc for root user"
      ansible.builtin.template:
        src: templates/bashrc.j2
        dest: /root/.bashrc
        owner: root
        group: root
        mode: '0644'
        backup: true
